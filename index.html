<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fetch Campaign Analytics Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f7f8fa;
            padding: 20px;
            color: #1a1a1a;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            margin-bottom: 40px;
            background: white;
            padding: 32px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        h1 {
            font-size: 2em;
            color: #1a1a1a;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .subtitle {
            color: #6b7280;
            font-size: 1em;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .upload-btn {
            background: #8b5cf6;
            color: white;
            padding: 12px 28px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: background 0.2s;
            font-weight: 500;
        }
        
        .upload-btn:hover {
            background: #7c3aed;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .metric-card {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
            border-left: 4px solid #8b5cf6;
        }
        
        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.15);
        }
        
        .metric-title {
            color: #6b7280;
            font-size: 0.875em;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 500;
        }
        
        .metric-value {
            font-size: 2.25em;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 4px;
        }
        
        .metric-subtitle {
            color: #9ca3af;
            font-size: 0.75em;
            margin-top: 6px;
            line-height: 1.4;
        }
        
        .date-input-container {
            margin: 20px 0;
        }
        
        .date-label {
            display: block;
            margin-bottom: 8px;
            color: #374151;
            font-weight: 500;
            font-size: 0.9em;
        }
        
        input[type="date"] {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1em;
            color: #1a1a1a;
            background: white;
            transition: border-color 0.2s;
        }
        
        input[type="date"]:focus {
            outline: none;
            border-color: #8b5cf6;
        }
        
        .date-inputs-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .quick-filters {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .quick-filter-btn {
            padding: 10px 20px;
            background: #f3f4f6;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.2s;
            font-weight: 500;
            color: #374151;
        }
        
        .quick-filter-btn:hover {
            background: #e5e7eb;
            border-color: #d1d5db;
        }
        
        .quick-filter-btn.active {
            background: #8b5cf6;
            color: white;
            border-color: #8b5cf6;
        }
        
        .campaign-list {
            margin-top: 20px;
        }
        
        .campaign-item {
            padding: 20px;
            margin: 12px 0;
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .campaign-item:hover {
            background: #f3f4f6;
            border-color: #d1d5db;
        }
        
        .campaign-item.selected {
            background: #f3f4f6;
            border-color: #8b5cf6;
            box-shadow: 0 0 0 1px #8b5cf6;
        }
        
        .campaign-name {
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 6px;
            font-size: 1.05em;
        }
        
        .campaign-meta {
            font-size: 0.9em;
            color: #6b7280;
        }
        
        .delete-btn {
            float: right;
            background: #ef4444;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875em;
            font-weight: 500;
            transition: background 0.2s;
        }
        
        .delete-btn:hover {
            background: #dc2626;
        }
        
        .section-title {
            font-size: 1.5em;
            color: #1a1a1a;
            margin-bottom: 20px;
            font-weight: 600;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
        }
        
        .empty-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }
        
        input[type="file"] {
            display: none;
        }
        
        .flex-between {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            padding: 14px 16px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        th {
            background: #f9fafb;
            font-weight: 600;
            color: #374151;
            font-size: 0.875em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        td {
            color: #1a1a1a;
        }

        tr:hover {
            background: #f9fafb;
        }

        h2 {
            font-size: 1.25em;
            font-weight: 600;
            color: #1a1a1a;
        }

        .info-text {
            color: #6b7280;
            margin-top: 16px;
            font-size: 0.9em;
        }

        .collapse-btn {
            background: #f3f4f6;
            border: 2px solid #e5e7eb;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            color: #374151;
            transition: all 0.2s;
            margin-bottom: 16px;
            display: inline-block;
        }

        .collapse-btn:hover {
            background: #e5e7eb;
        }

        .collapse-btn.active {
            background: #8b5cf6;
            color: white;
            border-color: #8b5cf6;
        }

        .chart-container {
            position: relative;
            width: 100%;
            height: 400px;
            margin-top: 20px;
        }

        .chart-toggles {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            margin-bottom: 20px;
            padding: 16px;
            background: #f9fafb;
            border-radius: 8px;
        }

        .chart-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            user-select: none;
        }

        .chart-toggle input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #8b5cf6;
        }

        .chart-toggle label {
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
            color: #374151;
        }

        #trendChart {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Fetch Campaign Analytics</h1>
            <p class="subtitle">Upload and analyze your campaign performance data</p>
        </div>

        <div class="card">
            <div class="flex-between">
                <div>
                    <h2>Upload Campaign Data</h2>
                    <p class="info-text" style="margin-top: 8px;">Upload CSV files from your Fetch campaigns</p>
                </div>
                <label for="fileInput" class="upload-btn">Upload CSV</label>
                <input type="file" id="fileInput" accept=".csv">
            </div>
        </div>

        <div id="campaignList"></div>
        <div id="dateFilter"></div>
        <div id="metrics"></div>
        <div id="trendsChart"></div>
        <div id="dataTable"></div>
    </div>

    <script>
        let campaigns = [];
        let selectedCampaign = null;
        let startDate = null;
        let endDate = null;

        // Load saved campaigns
        const savedCampaigns = localStorage.getItem('fetchCampaigns');
        if (savedCampaigns) {
            campaigns = JSON.parse(savedCampaigns);
            if (campaigns.length > 0) {
                selectedCampaign = campaigns[0];
                initializeDates();
            }
        }

        function initializeDates() {
            if (selectedCampaign && selectedCampaign.dailyData.length > 0) {
                startDate = selectedCampaign.dailyData[0].date;
                endDate = selectedCampaign.dailyData[selectedCampaign.dailyData.length - 1].date;
            }
        }

        // File upload handler
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const csv = event.target.result;
                    processCampaignData(csv, file.name);
                };
                reader.readAsText(file);
            }
        });

        function parseCSV(csv) {
            const lines = csv.split('\n');
            const result = [];
            
            for (let line of lines) {
                if (!line.trim()) continue;
                
                const row = [];
                let current = '';
                let inQuotes = false;
                
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        row.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                row.push(current.trim());
                result.push(row);
            }
            
            return result;
        }

        function processCampaignData(csv, filename) {
            const data = parseCSV(csv);
            
            let dailyDataStartIndex = -1;
            for (let i = 0; i < data.length; i++) {
                if (data[i][0] === 'Buyer Volume') {
                    dailyDataStartIndex = i + 2;
                    break;
                }
            }
            
            if (dailyDataStartIndex === -1) {
                alert('Could not find daily data in CSV');
                return;
            }
            
            const campaignName = data[1] ? data[1][0].replace(/"/g, '') : filename;
            
            const dailyData = [];
            for (let i = dailyDataStartIndex; i < data.length; i++) {
                const row = data[i];
                if (row.length < 5 || !row[0]) break;
                
                const parseValue = (val) => {
                    if (!val || val === '-') return 0;
                    return parseFloat(val.replace(/[$,]/g, ''));
                };
                
                dailyData.push({
                    date: row[0],
                    sales: parseValue(row[1]),
                    units: parseValue(row[2]),
                    trips: parseValue(row[3]),
                    buyers: parseValue(row[4]),
                    cost: parseValue(row[5])
                });
            }
            
            const newCampaign = {
                id: Date.now(),
                name: campaignName,
                uploadDate: new Date().toISOString(),
                dailyData: dailyData
            };
            
            campaigns.unshift(newCampaign);
            selectedCampaign = newCampaign;
            initializeDates();
            
            saveCampaigns();
            render();
        }

        function saveCampaigns() {
            localStorage.setItem('fetchCampaigns', JSON.stringify(campaigns));
        }

        function getFilteredData() {
            if (!selectedCampaign) return [];
            
            return selectedCampaign.dailyData.filter(day => {
                return day.date >= startDate && day.date <= endDate;
            });
        }

        function calculateMetrics(data) {
            if (data.length === 0) return null;
            
            const totals = data.reduce((acc, day) => ({
                sales: acc.sales + day.sales,
                units: acc.units + day.units,
                trips: acc.trips + day.trips,
                buyers: acc.buyers + day.buyers,
                cost: acc.cost + day.cost
            }), { sales: 0, units: 0, trips: 0, buyers: 0, cost: 0 });
            
            const days = data.length;
            
            return {
                totalSales: totals.sales,
                totalUnits: totals.units,
                totalTrips: totals.trips,
                totalBuyers: totals.buyers,
                totalCost: totals.cost,
                roas: totals.cost > 0 ? totals.sales / totals.cost : 0,
                tripsPerBuyer: totals.buyers > 0 ? totals.trips / totals.buyers : 0,
                aov: totals.trips > 0 ? totals.sales / totals.trips : 0,
                cpa: totals.buyers > 0 ? totals.cost / totals.buyers : 0,
                costPerTrip: totals.trips > 0 ? totals.cost / totals.trips : 0,
                unitsPerTrip: totals.trips > 0 ? totals.units / totals.trips : 0,
                unitsPerBuyer: totals.buyers > 0 ? totals.units / totals.buyers : 0,
                salesPerDay: days > 0 ? totals.sales / days : 0,
                costPerUnit: totals.units > 0 ? totals.cost / totals.units : 0,
                averageSalesPerBuyer: totals.buyers > 0 ? totals.sales / totals.buyers : 0
            };
        }

        function formatCurrency(value) {
            return '$' + value.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function formatNumber(value) {
            return value.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function formatWholeNumber(value) {
            return Math.round(value).toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
        }

        function render() {
            renderCampaignList();
            renderDateFilter();
            renderMetrics();
            renderTrendsChart();
            renderDataTable();
        }

        let tableCollapsed = false;
        let chartInstance = null;
        let chartMetrics = {
            sales: true,
            cost: true,
            roas: false,
            units: false,
            trips: false,
            buyers: false
        };

        function renderTrendsChart() {
            const container = document.getElementById('trendsChart');
            const filteredData = getFilteredData();
            
            if (filteredData.length === 0) {
                container.innerHTML = '';
                return;
            }

            container.innerHTML = `
                <div class="card">
                    <h2 class="section-title">Campaign Trends</h2>
                    <div class="chart-toggles">
                        <div class="chart-toggle">
                            <input type="checkbox" id="toggle-sales" ${chartMetrics.sales ? 'checked' : ''} onchange="toggleChartMetric('sales', this.checked)">
                            <label for="toggle-sales">Sales ($)</label>
                        </div>
                        <div class="chart-toggle">
                            <input type="checkbox" id="toggle-cost" ${chartMetrics.cost ? 'checked' : ''} onchange="toggleChartMetric('cost', this.checked)">
                            <label for="toggle-cost">Cost ($)</label>
                        </div>
                        <div class="chart-toggle">
                            <input type="checkbox" id="toggle-roas" ${chartMetrics.roas ? 'checked' : ''} onchange="toggleChartMetric('roas', this.checked)">
                            <label for="toggle-roas">ROAS</label>
                        </div>
                        <div class="chart-toggle">
                            <input type="checkbox" id="toggle-units" ${chartMetrics.units ? 'checked' : ''} onchange="toggleChartMetric('units', this.checked)">
                            <label for="toggle-units">Units</label>
                        </div>
                        <div class="chart-toggle">
                            <input type="checkbox" id="toggle-trips" ${chartMetrics.trips ? 'checked' : ''} onchange="toggleChartMetric('trips', this.checked)">
                            <label for="toggle-trips">Trips</label>
                        </div>
                        <div class="chart-toggle">
                            <input type="checkbox" id="toggle-buyers" ${chartMetrics.buyers ? 'checked' : ''} onchange="toggleChartMetric('buyers', this.checked)">
                            <label for="toggle-buyers">Buyers</label>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="trendChart"></canvas>
                    </div>
                </div>
            `;

            drawChart();
        }

        function toggleChartMetric(metric, enabled) {
            chartMetrics[metric] = enabled;
            drawChart();
        }

        function drawChart() {
            const canvas = document.getElementById('trendChart');
            if (!canvas) return;

            const filteredData = getFilteredData();
            if (filteredData.length === 0) return;

            // Destroy existing chart instance
            if (chartInstance) {
                chartInstance.destroy();
            }

            // Prepare data with calculated ROAS
            const chartData = filteredData.map(d => ({
                ...d,
                roas: d.cost > 0 ? d.sales / d.cost : 0
            }));

            // Define metric configurations
            const metricConfigs = {
                sales: { label: 'Sales', color: '#10b981', yAxisID: 'y-currency', format: 'currency' },
                cost: { label: 'Cost', color: '#ef4444', yAxisID: 'y-currency', format: 'currency' },
                roas: { label: 'ROAS', color: '#8b5cf6', yAxisID: 'y-ratio', format: 'number' },
                units: { label: 'Units', color: '#3b82f6', yAxisID: 'y-count', format: 'whole' },
                trips: { label: 'Trips', color: '#f59e0b', yAxisID: 'y-count', format: 'whole' },
                buyers: { label: 'Buyers', color: '#ec4899', yAxisID: 'y-count', format: 'whole' }
            };

            // Get active metrics
            const activeMetrics = Object.keys(chartMetrics).filter(k => chartMetrics[k]);
            
            if (activeMetrics.length === 0) {
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#6b7280';
                ctx.font = '14px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('Select at least one metric to display', canvas.width / 2, canvas.height / 2);
                return;
            }

            // Determine which y-axes to show based on active metrics
            const activeYAxes = new Set(activeMetrics.map(m => metricConfigs[m].yAxisID));
            
            // Build datasets
            const datasets = activeMetrics.map(metric => {
                const config = metricConfigs[metric];
                return {
                    label: config.label,
                    data: chartData.map(d => d[metric]),
                    borderColor: config.color,
                    backgroundColor: config.color + '20',
                    borderWidth: 2,
                    pointRadius: 3,
                    pointHoverRadius: 6,
                    tension: 0.1,
                    yAxisID: config.yAxisID,
                    format: config.format
                };
            });

            // Build y-axes configuration
            const yAxes = {};
            
            if (activeYAxes.has('y-currency')) {
                yAxes['y-currency'] = {
                    type: 'linear',
                    position: 'left',
                    title: {
                        display: true,
                        text: 'Currency ($)',
                        color: '#374151',
                        font: { weight: '500' }
                    },
                    ticks: {
                        callback: function(value) {
                            return '$' + value.toLocaleString('en-US', { maximumFractionDigits: 0 });
                        },
                        color: '#6b7280'
                    },
                    grid: {
                        color: '#e5e7eb'
                    }
                };
            }
            
            if (activeYAxes.has('y-ratio')) {
                yAxes['y-ratio'] = {
                    type: 'linear',
                    position: activeYAxes.has('y-currency') ? 'right' : 'left',
                    title: {
                        display: true,
                        text: 'ROAS',
                        color: '#374151',
                        font: { weight: '500' }
                    },
                    ticks: {
                        callback: function(value) {
                            return value.toFixed(2);
                        },
                        color: '#6b7280'
                    },
                    grid: {
                        display: !activeYAxes.has('y-currency'),
                        color: '#e5e7eb'
                    }
                };
            }
            
            if (activeYAxes.has('y-count')) {
                yAxes['y-count'] = {
                    type: 'linear',
                    position: 'right',
                    title: {
                        display: true,
                        text: 'Count',
                        color: '#374151',
                        font: { weight: '500' }
                    },
                    ticks: {
                        callback: function(value) {
                            return value.toLocaleString('en-US', { maximumFractionDigits: 0 });
                        },
                        color: '#6b7280'
                    },
                    grid: {
                        display: false
                    }
                };
            }

            // Create chart
            const ctx = canvas.getContext('2d');
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartData.map(d => d.date),
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: {
                                usePointStyle: true,
                                padding: 15,
                                font: {
                                    size: 12,
                                    weight: '500'
                                },
                                color: '#374151'
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            padding: 12,
                            displayColors: true,
                            callbacks: {
                                title: function(context) {
                                    const date = new Date(context[0].label);
                                    return date.toLocaleDateString('en-US', { 
                                        weekday: 'short',
                                        year: 'numeric', 
                                        month: 'short', 
                                        day: 'numeric' 
                                    });
                                },
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    
                                    const format = context.dataset.format;
                                    const value = context.parsed.y;
                                    
                                    if (format === 'currency') {
                                        label += '$' + value.toLocaleString('en-US', { 
                                            minimumFractionDigits: 2, 
                                            maximumFractionDigits: 2 
                                        });
                                    } else if (format === 'whole') {
                                        label += Math.round(value).toLocaleString('en-US');
                                    } else {
                                        label += value.toLocaleString('en-US', { 
                                            minimumFractionDigits: 2, 
                                            maximumFractionDigits: 2 
                                        });
                                    }
                                    
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Date',
                                color: '#374151',
                                font: { weight: '500' }
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45,
                                autoSkip: true,
                                maxTicksLimit: 12,
                                color: '#6b7280',
                                callback: function(value, index) {
                                    const date = new Date(this.getLabelForValue(value));
                                    return date.toLocaleDateString('en-US', { 
                                        month: 'short', 
                                        day: 'numeric' 
                                    });
                                }
                            },
                            grid: {
                                color: '#f3f4f6'
                            }
                        },
                        ...yAxes
                    }
                }
            });
        }

        function toggleTable() {
            tableCollapsed = !tableCollapsed;
            renderDataTable();
        }

        function renderCampaignList() {
            const container = document.getElementById('campaignList');
            
            if (campaigns.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            let html = '<div class="card"><h2>Saved Campaigns</h2><div class="campaign-list">';
            
            campaigns.forEach(campaign => {
                const isSelected = selectedCampaign && selectedCampaign.id === campaign.id;
                html += `
                    <div class="campaign-item ${isSelected ? 'selected' : ''}" onclick="selectCampaign(${campaign.id})">
                        <button class="delete-btn" onclick="event.stopPropagation(); deleteCampaign(${campaign.id})">Delete</button>
                        <div class="campaign-name">${campaign.name}</div>
                        <div class="campaign-meta">${campaign.dailyData.length} days of data â€¢ Uploaded ${new Date(campaign.uploadDate).toLocaleDateString()}</div>
                    </div>
                `;
            });
            
            html += '</div></div>';
            container.innerHTML = html;
        }

        function renderDateFilter() {
            const container = document.getElementById('dateFilter');
            
            if (!selectedCampaign) {
                container.innerHTML = '';
                return;
            }
            
            const minDate = selectedCampaign.dailyData[0].date;
            const maxDate = selectedCampaign.dailyData[selectedCampaign.dailyData.length - 1].date;
            
            container.innerHTML = `
                <div class="card">
                    <h2>Date Range Filter</h2>
                    <div class="date-inputs-row">
                        <div class="date-input-container">
                            <label class="date-label">Start Date</label>
                            <input type="date" id="startDateInput" value="${startDate}" min="${minDate}" max="${maxDate}" onchange="updateStartDate(this.value)">
                        </div>
                        <div class="date-input-container">
                            <label class="date-label">End Date</label>
                            <input type="date" id="endDateInput" value="${endDate}" min="${minDate}" max="${maxDate}" onchange="updateEndDate(this.value)">
                        </div>
                    </div>
                    <div class="quick-filters">
                        <button class="quick-filter-btn" onclick="setQuickFilter('all')">All Time</button>
                        <button class="quick-filter-btn" onclick="setQuickFilter(7)">Last 7 Days</button>
                        <button class="quick-filter-btn" onclick="setQuickFilter(30)">Last 30 Days</button>
                        <button class="quick-filter-btn" onclick="setQuickFilter(60)">Last 60 Days</button>
                        <button class="quick-filter-btn" onclick="setQuickFilter(90)">Last 90 Days</button>
                    </div>
                    <p class="info-text">Showing ${getFilteredData().length} days of data</p>
                </div>
            `;
        }

        function setQuickFilter(days) {
            if (!selectedCampaign) return;
            
            const data = selectedCampaign.dailyData;
            endDate = data[data.length - 1].date;
            
            if (days === 'all') {
                startDate = data[0].date;
            } else {
                const endDateObj = new Date(endDate);
                endDateObj.setDate(endDateObj.getDate() - days);
                const calculatedStart = endDateObj.toISOString().split('T')[0];
                
                // Find the closest actual date in our data
                let closestDate = data[0].date;
                for (let i = 0; i < data.length; i++) {
                    if (data[i].date >= calculatedStart) {
                        closestDate = data[i].date;
                        break;
                    }
                }
                startDate = closestDate;
            }
            
            render();
        }

        function updateStartDate(value) {
            startDate = value;
            render();
        }

        function updateEndDate(value) {
            endDate = value;
            render();
        }

        function renderMetrics() {
            const container = document.getElementById('metrics');
            const filteredData = getFilteredData();
            const metrics = calculateMetrics(filteredData);
            
            if (!metrics) {
                container.innerHTML = '';
                return;
            }
            
            container.innerHTML = `
                <div class="card" style="margin-bottom: 32px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 32px;">
                        <div>
                            <div style="color: #6b7280; font-size: 0.75em; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; font-weight: 500;">COST</div>
                            <div style="font-size: 2em; font-weight: 600; color: #1a1a1a;">${formatCurrency(metrics.totalCost)}</div>
                        </div>
                        <div>
                            <div style="color: #6b7280; font-size: 0.75em; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; font-weight: 500;">SALES</div>
                            <div style="font-size: 2em; font-weight: 600; color: #1a1a1a;">${formatCurrency(metrics.totalSales)}</div>
                        </div>
                        <div>
                            <div style="color: #6b7280; font-size: 0.75em; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; font-weight: 500;">UNITS</div>
                            <div style="font-size: 2em; font-weight: 600; color: #1a1a1a;">${formatWholeNumber(metrics.totalUnits)}</div>
                        </div>
                        <div>
                            <div style="color: #6b7280; font-size: 0.75em; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; font-weight: 500;">BUYERS</div>
                            <div style="font-size: 2em; font-weight: 600; color: #1a1a1a;">${formatWholeNumber(metrics.totalBuyers)}</div>
                        </div>
                        <div>
                            <div style="color: #6b7280; font-size: 0.75em; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; font-weight: 500;">TRIPS</div>
                            <div style="font-size: 2em; font-weight: 600; color: #1a1a1a;">${formatWholeNumber(metrics.totalTrips)}</div>
                        </div>
                    </div>
                </div>
                
                <h2 class="section-title">Performance Metrics</h2>
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-title">ROAS</div>
                        <div class="metric-value" style="color: #10b981;">${formatNumber(metrics.roas)}</div>
                        <div class="metric-subtitle">Return on Ad Spend</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-title">Cost per Unit Moved</div>
                        <div class="metric-value">${formatCurrency(metrics.costPerUnit)}</div>
                        <div class="metric-subtitle">Total campaign cost / units sold</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-title">Customer Acquisition Cost (CAC)</div>
                        <div class="metric-value">${formatCurrency(metrics.cpa)}</div>
                        <div class="metric-subtitle"><strong>Only applies to Non-Brand and Competitive Offers</strong></div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-title">Units per Trip</div>
                        <div class="metric-value">${formatNumber(metrics.unitsPerTrip)}</div>
                        <div class="metric-subtitle">Basket size</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-title">Daily Average Sales</div>
                        <div class="metric-value">${formatCurrency(metrics.salesPerDay)}</div>
                    </div>
                </div>
            `;
        }

        function renderDataTable() {
            const container = document.getElementById('dataTable');
            const filteredData = getFilteredData();
            
            if (filteredData.length === 0) {
                if (!selectedCampaign && campaigns.length === 0) {
                    container.innerHTML = `
                        <div class="card empty-state">
                            <div class="empty-icon">ðŸ“Š</div>
                            <h3 style="font-size: 1.5em; margin-bottom: 8px;">No campaigns yet</h3>
                            <p class="info-text">Upload a CSV file to get started analyzing your Fetch campaigns</p>
                        </div>
                    `;
                }
                return;
            }
            
            let html = '<div class="card">';
            html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">';
            html += '<h2 class="section-title" style="margin-bottom: 0;">Daily Data</h2>';
            html += `<button class="collapse-btn ${tableCollapsed ? '' : 'active'}" onclick="toggleTable()">`;
            html += tableCollapsed ? 'Show Table' : 'Hide Table';
            html += '</button></div>';
            
            if (!tableCollapsed) {
                html += '<table><thead><tr>';
                html += '<th>Date</th><th>Sales</th><th>Units</th><th>Trips</th><th>Buyers</th><th>Cost</th>';
                html += '</tr></thead><tbody>';
                
                filteredData.forEach(row => {
                    html += `<tr>
                        <td>${row.date}</td>
                        <td>${formatCurrency(row.sales)}</td>
                        <td>${formatWholeNumber(row.units)}</td>
                        <td>${formatWholeNumber(row.trips)}</td>
                        <td>${formatWholeNumber(row.buyers)}</td>
                        <td>${formatCurrency(row.cost)}</td>
                    </tr>`;
                });
                
                html += '</tbody></table>';
            }
            
            html += '</div>';
            container.innerHTML = html;
        }

        function selectCampaign(id) {
            selectedCampaign = campaigns.find(c => c.id === id);
            initializeDates();
            render();
        }

        function deleteCampaign(id) {
            if (confirm('Delete this campaign?')) {
                campaigns = campaigns.filter(c => c.id !== id);
                if (selectedCampaign && selectedCampaign.id === id) {
                    selectedCampaign = campaigns[0] || null;
                    if (selectedCampaign) {
                        initializeDates();
                    }
                }
                saveCampaigns();
                render();
            }
        }

        // Initial render
        render();

        // Chart.js handles responsive resizing automatically
        // Just redraw if window resizes significantly
        let resizeTimeout;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                if (chartInstance) {
                    chartInstance.resize();
                }
            }, 250);
        });
    </script>
</body>
</html>
